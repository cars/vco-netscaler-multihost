<?xml version="1.0" encoding="UTF-8"?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item1" object-name="workflow:name=generic" id="51bc8efb-c447-48fc-b31d-6c703d4d88c8" version="1.1.0" api-version="3.1.0" allowed-operations="fve" restartMode="1" resumeFromFailedMode="0">
    <display-name>Add Virtual Server to Netscaler</display-name>

    <position x="100.0" y="50.0"/>

    <input>
        <param name="vserverName" type="string"/>
        <param name="vserverProtocol" type="string"/>
        <param name="vserverIP" type="string"/>
        <param name="vserverPort" type="string"/>
        <param name="vserverLBMethod" type="string"/>
        <param name="vserverPersistence" type="string"/>
        <param name="vserverComment" type="string"/>
        <param name="sslCertKey" type="string"/>
        <param name="doSSL" type="boolean">
            <description>Assign an SSL Certificate</description>
        </param>
        <param name="nsRestHostName" type="string"/>
    </input>

    <output>
        <param name="sslBindingContentLength" type="Number">
            <description>Response content length</description>
        </param>
        <param name="sslBindingHeaders" type="Properties">
            <description>Response headers</description>
        </param>
        <param name="sslBindingContentAsString" type="String">
            <description>Response content as string</description>
        </param>
        <param name="addServerStatusCode" type="Number">
            <description>Response status code</description>
        </param>
        <param name="addServerContentLength" type="Number">
            <description>Response content length</description>
        </param>
        <param name="addServerHeaders" type="Properties">
            <description>Response headers</description>
        </param>
        <param name="addServerContentAsString" type="String">
            <description>Response content as string</description>
        </param>
        <param name="sslBindingStatusCode" type="Number">
            <description>Response status code</description>
        </param>
    </output>

    <attrib name="content" type="String" read-only="false">
        <value encoded="n"/>
        <description>content</description>
    </attrib>
    <attrib name="ProtocolArray" type="Array/string" read-only="true">
        <value encoded="n">#{#string#HTTP#;#string#FTP#;#string#TCP#;#string#UDP#;#string#SSL#;#string#SSL_BRIDGE#;#string#SSL_TCP#;#string#DTLS#;#string#NNTP#;#string#DNS#;#string#DHCPRA#;#string#ANY#;#string#SIP_UDP#;#string#DNS_TCP#;#string#RTSP#;#string#PUSH#;#string#SSL_PUSH#;#string#RADIUS#;#string#RDP#;#string#MYSQL#;#string#MSSQL#;#string#DIAMETER#;#string#SSL_DIAMETER#;#string#TFTP#;#string#ORACLE#}#</value>
    </attrib>
    <attrib name="PersistenceTypeArray" type="Array/string" read-only="false">
        <value encoded="n">#{#string#SOURCEIP#;#string#COOKIEINSERT#;#string#SSLSESSION#;#string#RULE#;#string#URLPASSIVE#;#string#CUSTOMERSERVERID#;#string#DESTIP#;#string#SRCIPDESTIP#;#string#CALLID#;#string#RTSPID#;#string#DIAMETER#;#string#NONE#}#</value>
    </attrib>
    <attrib name="LBMethodArray" type="Array/string" read-only="false">
        <value encoded="n">#{#string#LEASTCONNECTION#;#string#ROUNDROBIN#;#string#LEASTRESPONSETIME#;#string#URLHASH#;#string#DOMAINHASH#;#string#DESTINATIONIPHASH#;#string#SOURCEIPHASH#;#string#SRCIPDESTIPHASH#;#string#CALLIDHASH#;#string#SRCIPSRCPORTHASH#;#string#LEASTBANDWIDTH#;#string#LEASTPACKETS#;#string#CUSTOMLOAD#;#string#TOKEN#;#string#LRTM#}#</value>
    </attrib>
    <attrib name="nsRestHost" type="REST:RESTHost" read-only="false">
        <value encoded="n">__NULL__</value>
    </attrib>
    <attrib name="nsRestOperation" type="REST:RESTOperation" read-only="false">
        <value encoded="n">__NULL__</value>
    </attrib>
    <attrib name="nsRestOperationName" type="string" read-only="false">
        <value encoded="n">NetScaler-Vserver-Add</value>
    </attrib>
    <attrib name="nsSSLRestOperationName" type="string" read-only="false">
        <value encoded="n">NetScaler-SSLServer-Certificate-Binding-Add</value>
    </attrib>
    <attrib name="SSLenableContent" type="string" read-only="false">
        <value encoded="n"/>
    </attrib>

    <workflow-item name="item0" type="end" end-mode="0">
        <position x="924.5" y="199.95454545454544"/>
    </workflow-item>

    <workflow-item name="item3" out-name="item7" type="condition" alt-out-name="item0" comparator="0">
        <display-name>Add SSL Cert</display-name>

        <script encoded="false">
//Generated by the system, cannot be edited
return (doSSL == true) ;
        </script>

        <in-binding>
            <bind name="doSSL" type="boolean" export-name="doSSL"/>
        </in-binding>
        <condition name="doSSL" type="boolean" comparator="0" label="null">false</condition>

        <position x="784.5" y="45.40909090909091"/>
    </workflow-item>

    <workflow-item name="item4" out-name="item5" type="task">
        <display-name>Build REST content</display-name>

        <script encoded="false">
//prepare content of the request...
content = '{\n "lbvserver": {\n "name": "' + vserverName + '",\n"servicetype": "'+ vserverProtocol + '",\n';
content += '"ipv46": "'+vserverIP + '",\n "port": "'+vserverPort+'"';
if (vserverComment !== null  &amp;&amp; vserverComment.length &gt;= 1){ 
	content += ',\n"comment": "'+ vserverComment + '"';
}

if (vserverLBMethod !== null  &amp;&amp; vserverLBMethod.length &gt;=1){ 
	content += ',\n"lbmethod": "'+ vserverLBMethod + '"';
}

if (vserverPersistence !== null &amp;&amp; vserverPersistence.length &gt;=1 ){ 
	content += ',\n"persistencetype": "'+ vserverPersistence+ '"';
}


content += '}}';

System.log("content: " + content);



SSLenableContent = '\
{\
"sslvserver_sslcertkey_binding":\
	{\
		"vServerName":"'+vserverName+'",\
		"certKeyName":"'+sslCertKey+'"\
	}\
}\
';
        </script>

        <in-binding>
            <bind name="vserverName" type="string" export-name="vserverName"/>
            <bind name="vserverProtocol" type="string" export-name="vserverProtocol"/>
            <bind name="vserverIP" type="string" export-name="vserverIP"/>
            <bind name="vserverPort" type="string" export-name="vserverPort"/>
            <bind name="vserverLBMethod" type="string" export-name="vserverLBMethod"/>
            <bind name="vserverPersistence" type="string" export-name="vserverPersistence"/>
            <bind name="vserverComment" type="string" export-name="vserverComment"/>
            <bind name="sslCertKey" type="string" export-name="sslCertKey"/>
        </in-binding>

        <out-binding>
            <bind name="content" type="String" export-name="content">
                <description>content</description>
            </bind>
            <bind name="SSLenableContent" type="string" export-name="SSLenableContent"/>
        </out-binding>

        <description>Scripting component to build the JSON content for the REST operation.</description>

        <position x="484.5" y="55.40909090909091"/>
    </workflow-item>

    <workflow-item name="item1" out-name="item2" type="task" script-module="org.lostroncos.library.netscaler.multihost/getNSRestHostByName">
        <display-name>getNSRestHostByName</display-name>

        <script encoded="false">
//Auto generated script, cannot be modified !
actionResult = System.getModule("org.lostroncos.library.netscaler.multihost").getNSRestHostByName(nsRestHostName) ;
        </script>

        <in-binding>
            <bind name="nsRestHostName" type="string" export-name="nsRestHostName"/>
        </in-binding>

        <out-binding>
            <bind name="actionResult" type="REST:RESTHost" export-name="nsRestHost"/>
        </out-binding>

        <position x="204.5" y="55.40909090909091"/>
    </workflow-item>

    <workflow-item name="item2" out-name="item4" type="task" script-module="org.lostroncos.library.netscaler.multihost/getNSRestOperationByName">
        <display-name>getNSRestOperationByName</display-name>

        <script encoded="false">
//Auto generated script, cannot be modified !
actionResult = System.getModule("org.lostroncos.library.netscaler.multihost").getNSRestOperationByName(nsRestHost,nsRestOperationName) ;
        </script>

        <in-binding>
            <bind name="nsRestHost" type="REST:RESTHost" export-name="nsRestHost"/>
            <bind name="nsRestOperationName" type="string" export-name="nsRestOperationName"/>
        </in-binding>

        <out-binding>
            <bind name="actionResult" type="REST:RESTOperation" export-name="nsRestOperation"/>
        </out-binding>

        <position x="345.0" y="55.90909090909091"/>
    </workflow-item>

    <workflow-item name="item5" out-name="item3" type="link" linked-workflow-id="e0e0674f-52b3-4003-9b76-704ae0a1d045">
        <display-name>Add vServer</display-name>

        <in-binding>
            <bind name="restOperation" type="REST:RESTOperation" export-name="nsRestOperation"/>
            <bind name="content" type="String" export-name="content">
                <description>content</description>
            </bind>
        </in-binding>

        <out-binding>
            <bind name="statusCode" type="Number" explicitly-not-bound="true">
                <description>Response status code</description>
            </bind>
            <bind name="contentLength" type="Number" explicitly-not-bound="true">
                <description>Response content length</description>
            </bind>
            <bind name="headers" type="Properties" explicitly-not-bound="true">
                <description>Response headers</description>
            </bind>
            <bind name="contentAsString" type="String" explicitly-not-bound="true">
                <description>Response content as string</description>
            </bind>
        </out-binding>

        <description>Autogenerated workflow.</description>

        <position x="645.0" y="55.90909090909091"/>
    </workflow-item>

    <workflow-item name="item6" out-name="item0" type="link" linked-workflow-id="e0e0674f-52b3-4003-9b76-704ae0a1d045">
        <display-name>Enable SSL</display-name>

        <in-binding>
            <bind name="restOperation" type="REST:RESTOperation" export-name="nsRestOperation"/>
            <bind name="content" type="String" export-name="SSLenableContent">
                <description>content</description>
            </bind>
        </in-binding>

        <out-binding>
            <bind name="statusCode" type="Number" explicitly-not-bound="true">
                <description>Response status code</description>
            </bind>
            <bind name="contentLength" type="Number" explicitly-not-bound="true">
                <description>Response content length</description>
            </bind>
            <bind name="headers" type="Properties" explicitly-not-bound="true">
                <description>Response headers</description>
            </bind>
            <bind name="contentAsString" type="String" explicitly-not-bound="true">
                <description>Response content as string</description>
            </bind>
        </out-binding>

        <position x="1004.5" y="119.04545454545453"/>
    </workflow-item>

    <workflow-item name="item7" out-name="item6" type="task" script-module="org.lostroncos.library.netscaler.multihost/getNSRestOperationByName">
        <display-name>getNSRestOperationByName</display-name>

        <script encoded="false">
//Auto generated script, cannot be modified !
actionResult = System.getModule("org.lostroncos.library.netscaler.multihost").getNSRestOperationByName(nsRestHost,nsRestOperationName) ;
        </script>

        <in-binding>
            <bind name="nsRestHost" type="REST:RESTHost" export-name="nsRestHost"/>
            <bind name="nsRestOperationName" type="string" export-name="nsSSLRestOperationName"/>
        </in-binding>

        <out-binding>
            <bind name="actionResult" type="REST:RESTOperation" export-name="nsRestOperation"/>
        </out-binding>

        <position x="1004.5" y="55.40909090909091"/>
    </workflow-item>

    <presentation>
        <p-step>
            <title>New step</title>
            <p-group>
                <title>VServer Properties</title>
                <desc>
VServer Properties
                </desc>
                <p-param name="vserverName">
                    <desc>vserverName</desc>
                    <p-qual kind="static" name="mandatory" type="boolean">true</p-qual>
                </p-param>
                <p-param name="vserverProtocol">
                    <desc>vserverProtocol</desc>
                    <p-qual kind="ognl" name="linkedEnumeration" type="Array/string">#ProtocolArray</p-qual>
                </p-param>
                <p-param name="vserverIP">
                    <desc>vserverIP</desc>
                    <p-qual kind="static" name="mandatory" type="boolean">true</p-qual>
                </p-param>
                <p-param name="vserverPort">
                    <desc>vserverPort</desc>
                    <p-qual kind="static" name="mandatory" type="boolean">true</p-qual>
                </p-param>
                <p-param name="vserverLBMethod">
                    <desc>vserverLBMethod</desc>
                    <p-qual kind="static" name="defaultValue" type="string">ROUNDROBIN</p-qual>
                    <p-qual kind="ognl" name="genericEnumeration" type="Array/string">#LBMethodArray</p-qual>
                </p-param>
                <p-param name="vserverPersistence">
                    <desc>vserverPersistence</desc>
                    <p-qual kind="static" name="mandatory" type="boolean">true</p-qual>
                    <p-qual kind="ognl" name="genericEnumeration" type="Array/string">#PersistenceTypeArray</p-qual>
                </p-param>
                <p-param name="vserverComment">
                    <desc>vserverComment</desc>
                </p-param>
            </p-group>
        </p-step>
        <p-step>
            <title>SSL Info</title>
            <p-group>
                <title>SSL Certificate Information</title>
                <p-param name="doSSL">
                    <desc>Assign an SSL Certificate</desc>
                    <p-qual kind="static" name="defaultValue" type="boolean">__NULL__</p-qual>
                </p-param>
                <p-param name="sslCertKey">
                    <desc>sslCertKey</desc>
                    <p-qual kind="ognl" name="visible" type="boolean">#doSSL</p-qual>
                    <p-qual kind="static" name="mandatory" type="boolean">true</p-qual>
                </p-param>
            </p-group>
        </p-step>
        <p-param name="nsRestHostName">
            <desc>nsRestHostName</desc>
            <p-qual kind="static" name="mandatory" type="boolean">true</p-qual>
        </p-param>
    </presentation>
</workflow>
